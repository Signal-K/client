# Mineral Deposit System Implementation

## Overview
Implemented an automated mineral deposit creation system that triggers when users complete weather satellite classifications. The system has a 1 in 3 chance of creating a mineral deposit if the user has researched the minerals function and the target planet is compatible.

## Files Created

### `/src/utils/mineralDepositCreation.ts`
Core utility module containing:

- **`hasMineralResearch()`**: Checks if user has unlocked mineral discovery (inventory item 3103)
- **`isPlanetCompatible()`**: Verifies planet has valid stats (density, radius, mass) from satellite surveys
- **`rollForMineralDeposit()`**: 1/3 chance probability roll
- **`createMineralDeposit()`**: Creates mineralDeposits table entry
- **`attemptMineralDepositCreation()`**: Main orchestration function that checks all conditions and creates deposit

**Mineral Selection Functions:**
- **`selectCloudMineral()`**: Returns water-ice or CO2-ice (50/50)
- **`selectJovianMineral()`**: Returns metallic-hydrogen (50%), metallic-helium (25%), methane (15%), or ammonia (10%)
- **`selectPlanetFourMineral()`**: Returns dust (40%), soil (30%), or water-vapour (30%)

Each mineral includes:
- Type
- Amount (random within range)
- Purity (70-100% for clouds, 60-100% for jovian, 50-100% for surface)
- Metadata (source, discovery method, etc.)

## Files Modified

### `Clouds.tsx` (Cloud on Mars)
- Added `onClassificationComplete` callback to both `StarterLidar` and `CloudspottingOnMarsWithId` components
- On classification completion:
  1. Fetches most recent cloud classification
  2. Calls `selectCloudMineral()` to randomly choose water-ice or CO2-ice
  3. Attempts deposit creation via `attemptMineralDepositCreation()`

### `CloudspottingOnMarsShapes.tsx` (Cloud Shapes)
- Added `onClassificationComplete` callback to `StarterCoMShapes` component
- Same logic as regular cloud classifications
- Creates water-ice or CO2-ice deposits

### `JovianVortexHunter.tsx` (Gas Giant Analysis)
- Added `onClassificationComplete` callbacks to both starter and main components
- On classification completion:
  1. Fetches most recent jovian vortex classification
  2. Calls `selectJovianMineral()` to choose deposit type based on Jupiter composition
  3. Attempts deposit creation with atmospheric metadata (pressure, depth)

### `PlanetFour.tsx` (Surface Analysis)
- Added `onClassificationComplete` callbacks to both `StarterPlanetFour` and `PlanetFourProject` components
- On classification completion:
  1. Fetches most recent surface classification with configuration
  2. Extracts annotation options from classification config
  3. Calls `selectPlanetFourMineral(annotations)` to choose deposit type
  4. Attempts deposit creation with surface type metadata

## Database Schema Used

```sql
create table public."mineralDeposits" (
  id bigint generated by default as identity not null,
  anomaly bigint null,
  owner uuid null,
  mineralconfiguration jsonb null,
  location text null,
  discovery bigint null,
  created_at timestamp with time zone null,
  "roverName" text null,
  constraint mineraldeposits_pkey primary key (id),
  constraint mineraldeposits_anomaly_fkey foreign key (anomaly) references anomalies (id),
  constraint mineraldeposits_owner_fkey foreign key (owner) references profiles (id),
  constraint mineraldeposits_discovery_fkey foreign key (discovery) references classifications (id)
);
```

## Mineral Types by Classification

| Classification Type | Possible Deposits | Probability Distribution |
|---------------------|-------------------|-------------------------|
| **Cloud on Mars (CoM)** | water-ice, co2-ice | 50% each |
| **Cloud Shapes (CoMS)** | water-ice, co2-ice | 50% each |
| **Jovian Vortex Hunter (JVH)** | metallic-hydrogen, metallic-helium, methane, ammonia | 50%, 25%, 15%, 10% |
| **Planet Four (P4)** | dust, soil, water-vapour | 40%, 30%, 30% |

## Requirements Checked

1. ✅ **Mineral Research Unlocked**: Checks inventory for item 3103
2. ✅ **Planet Compatibility**: Verifies planet has valid classification with stats (density, radius, mass not N/A)
3. ✅ **1 in 3 Chance**: Random roll determines if deposit is created
4. ✅ **Discovery Link**: Each deposit references the classification ID that created it

## Testing

To test the system:

1. Ensure user has mineral research unlocked (inventory item 3103)
2. Deploy a weather satellite to a planet with calculated stats
3. Complete cloud, shape, jovian, or surface classifications
4. Check console logs for mineral deposit creation messages
5. Verify entries in `mineralDeposits` table point to correct classification and anomaly

## Console Log Format

Successful deposit creation logs:
```
[CoM] Created water-ice deposit!
[CoM Shapes] Created co2-ice deposit!
[JVH] Created metallic-hydrogen deposit!
[Planet Four] Created soil deposit!
```

Internal logs:
```
[Mineral Research] User does not have mineral research unlocked
[Mineral Compatibility] Planet is not compatible for mineral discovery
[Mineral Deposit] Roll failed - no deposit created
[Mineral Deposit] Created water-ice deposit (ID: 123) for classification 456
```
